version: '3.8'

services:
  mongodb:
    image: mongo:latest
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - chatwmex-network

  chatwmex-backend:
    # Build from local directory
    build: .
    image: chatwmex-backend:local
    container_name: chatwmex-backend
    ports:
      - "8080:8080"  # Map host port 8080 to container port 8080
    environment:
      # Docker 環境標識
      - DOCKER_ENV=true
      - CONTAINER=true
      
      # 数据库配置
      # 在 Docker 內部強制使用 mongodb 服務名稱，忽略 .env 中的 localhost 配置
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017
      - MONGO_DB_NAME=${MONGO_DB_NAME:-chatwme_db}
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_SECRET=${ENCRYPTION_SECRET}
      
      # CloudFlare 配置
      - USE_CLOUDFLARE=true
      - STORAGE_BASE_URL=https://api-chatwmex.phdev.uk/uploads
      
      # 文件上传配置
      - UPLOAD_PATH=./uploads
      - MAX_VOICE_FILE_SIZE=5242880
      
      # 服务器配置
      - SERVER_PORT=:8080
      - LOG_LEVEL=info
    volumes:
      - ./uploads:/root/uploads  # 持久化上传文件
      - ./uploads/audio:/root/uploads/audio  # 確保語音文件目錄存在
      - ./uploads/avatars:/root/uploads/avatars  # 確保頭像目錄存在
    restart: unless-stopped
    depends_on:
      - mongodb
    networks:
      - chatwmex-network

volumes:
  mongodb_data:

networks:
  chatwmex-network:
    driver: bridge
